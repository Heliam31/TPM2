<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IOC: TP2 : Traduction en quadruplets</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">IOC<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">IOML compiler.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">TP2 : Traduction en quadruplets </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><em>Pour réaliser le TP, suivez les directives qui vont suivre et essayez de v indicatif fourni pour chaque partieous conformer au temps.</em></p>
<p>Le TP se clôture par la remise des sources que vous aurez produits sur le dépôt correspondant sur Moodle.</p>
<p>Pour obtenir l'archive à déposer, tapez la commande : <code>$ make tp3</code></p>
<p>Cela crée un fichier nommé <code>tp3-DATE.tgz</code> avec <em>DATE</em> représentant la date du jour.</p>
<h1><a class="anchor" id="autotoc_md11"></a>
Présentation du sélecteur d'instruction</h1>
<p>Le <em>sélecteur d'instruction</em> est implanté dans le fichier <code><a class="el" href="_inst_8cpp.html">Inst.cpp</a></code> qui exploite les classes déclarées dans <code><a class="el" href="_inst_8hpp.html">Inst.hpp</a></code>. Deux classes y sont définies :</p>
<ul>
<li>Le classe <code><a class="el" href="class_inst.html">Inst</a></code> définie une instruction machine sous format d'une chaîne de caractère et d'une liste de paramètre repris dans la chaîne de caractère par des <code>%0</code>, <code>%1</code>, etc.</li>
<li>La classe <code><a class="el" href="class_param.html">Param</a></code> définit les éléments des paramètres de <code><a class="el" href="class_inst.html">Inst</a></code>.</li>
</ul>
<p>Les paramètres sont de 2 types :</p>
<ul>
<li><code><a class="el" href="class_param.html#af6a50676a4286f1245006337e700516ca543aa6fdc375765d44b81a71d139f0ab">Param::CST</a></code> pour définir une valeur constant,</li>
<li><code><a class="el" href="class_param.html#af6a50676a4286f1245006337e700516ca237a9b7974bd1a57b127ac1afa154813">Param::READ</a></code> pour un registre lu,</li>
<li><code><a class="el" href="class_param.html#af6a50676a4286f1245006337e700516cad83995bf303c32baa7d3fae0339873a9">Param::WRITE</a></code> pour un registre écrit.</li>
</ul>
<p>Ces types vont également être utilisés plus tard pour l'<em>allocation des registres</em>.</p>
<p>Par exemple, l'instruction <code>add R6, R0, R1</code> sera déclarée par : </p><pre class="fragment">```C++
    Inst add("add %0, %1, %2", Param::write(6), Param::read(0), Param::read(1));
```
</pre><p> L'instruction <code>mov R3, #128</code> sera décrite par : </p><pre class="fragment">```C++
    Inst movi("mov %0, #%1", Param::write(3), Param::cst(128));
```
</pre><h1><a class="anchor" id="autotoc_md12"></a>
Fonctionnement du sélecteur d'instruction</h1>
<p>Le sélecteur implante un algorithme très simple : on lui donne une liste de quadruplets et il renvoie une liste d'instructions machine. Pour ce faire, il recherche la première entrée du tableau <code>selector</code> défini dans <code><a class="el" href="_inst_8cpp.html">Inst.cpp</a></code> correspond avec le début de la liste de quadruplets (cela peut être plusieurs quadruplets). Il les supprime de la liste des quadruplets et ajoute à les instructions machines correspondantes à la fin de la liste de instructions. Il réitère jusqu'à avoir consommé tous les quadruplets de la liste.</p>
<p>Pour ajouter une instruction machine, il suffit alors d'ajouter une entrée au tableau <code>selector</code>. Les éléments de ce tableau, de type <code><a class="el" href="structselect__t.html">select_t</a></code>, sont un couple :</p>
<ul>
<li>une liste de quadruplets à reconnaître,</li>
<li>une liste d'instruction machine à générer.</li>
</ul>
<p>Par exemple, on pourra reconnaître l'instruction <code>add</code> de l'ARM avec le sélecteur ci-dessous : </p><pre class="fragment">```C++
select_t
    select_add = {
        { Quad::add(RECORD|0, RECORD|1, RECORD|2) },
        { Inst("\tadd R%0, R%1, R%2", Param::write(COPY|0), Param::read(COPY|1), Param::read(COPY|2)), Inst::end }
    };
```
</pre><p> Ainsi le simple quadruplet <code>v31 &lt;- v50 + v49</code> génèrera l'instruction machine <code>add R31, R50, R49</code>. On notera que le modèle peut être composé de plusieurs quadruplets en séquence et qu'il peut y avoir plusieurs machines générées.</p>
<p>Pour réaliser l'identification des paramètres de quadruplet, les registres utilisées pour ces derniers sont décorés d'une action et d'un numéro comme <code>RECORD|0</code>. Ces actions ont la signification suivante :</p>
<ul>
<li><code>RECORD|i</code> - enregistrer le numéro de registre dans la mémoire <em>i</em>.</li>
<li><code>EQUAL|i</code> - le numéro de registre doit être égal à la mémoire <em>i</em>.</li>
<li><code>POW2|i</code> - correspond si le paramètre est une constante puissance de 2 et enregistrer dans <em>i</em>.</li>
<li><code>ISIMM|i</code> - correspond si le paramètre est une constante encodable dans une instruction ARM et enregistrer dans <em>i</em>.</li>
</ul>
<p>Les mémoires permettent de faire le lien avec les valeurs passées dans les paramètres des instructions comme <code>COPY|0</code>:</p>
<ul>
<li><code>COPY|i</code> - copier la valeur de la mémoire <em>i</em>.</li>
<li><code>LOG2|i</code> - copier le logarithme de 2 de la mémoire <em>i</em>.</li>
</ul>
<p>Ainsi, dans notre exemple, la mémoire <em>0</em> reçoit 31, la mémoire <em>1</em> reçoit 50 et la mémoire <em>2</em> 49. Quand on génèrera l'instruction machine, le premier paramètre prendra 31 et %0 sera remplacé par 31, etc.</p>
<p>Prenons comme autre exemple le <code>mov</code> avec une constante : </p><pre class="fragment">```C++
select_t
    select_movi = {
        { Quad::seti(RECORD|0, ISIMM|1) },
        { Inst("\tmov R%0, #%1", Param::write(COPY|0), Param::cst(COPY|1)), Inst::end }
    };
```
</pre><p> Si on doi générer le quadruplet <code>v45 &lt;- 1024</code> alors la mémoire <em>0</em> reçoit 45. La mémoire <em>1</em> reçoit 1024 car 1024 est encodable comme une constante immédiate en ARM.</p>
<h1><a class="anchor" id="autotoc_md13"></a>
A faire</h1>
<p>Quand on lance le sélecteur d'instruction et qu'il ne trouve pas une instruction, il affiche un avertissement avec le quadruplets qui n'est pas supporté.</p>
<p>[TODO]</p>
<ol type="1">
<li>En utilisant comme test <code>test/blink.io</code> et <code>test/pushdown.io</code>, ajoutez des instructions jusqu'à ce qu'il n'y est plus d'avertissement.</li>
</ol>
<p><b>NOTE 1</b> On pourra utiliser l'option <code>-print-select</code> pour afficher le résultat de la sélection des instructions.</p>
<p><b>NOTE 2</b> Pour réduire le travail d'écriture, on notera l'usage des fonction <em>inline</em> <code>pread</code>, <code>pwrite</code> et <code>pcst</code> à la place de <code><a class="el" href="class_param.html#aca1ce3023ba2313a213e529c765aedca">Param::read</a></code>, <code><a class="el" href="class_param.html#a75519464c4cd8bd5f9d22d924b81970a">Param::write</a></code> et <code><a class="el" href="class_param.html#abbda2fcbcf30e68a20389b46fc43a301">Param::cst</a></code>.</p>
<p><b>ATTENTION</b> Les structures <code><a class="el" href="structselect__t.html">select_t</a></code> doivent être déclarées séparemment puis leur adresse ajoutée aui tableau <code>selectors</code>.</p>
<ol type="1">
<li>Ajoutez des entrées <code><a class="el" href="structselect__t.html">select_t</a></code> qui permettent de remplacer les séquences <code>vi &lt;- n; vj &lt;- vk op vi</code> par une seule instruction machine dont le second paramètre est une valeur immédiate.</li>
<li>Utilisez le sélecteur d'instruction pour optimiser les séquences du type :<ul>
<li><code>goto l; label l</code> par <code>label l</code></li>
<li>&lsquo;goto_cc vi, vj, L; goto L&rsquo;; label L<code>par</code>goto_cc\ vi, vj, L'; label L`</li>
</ul>
</li>
<li>Certaines opérations peuvent également être simplifiées.<ul>
<li><code>vi &lt;- 2^n; vj &lt;- vk * vi</code> par <code>vi &lt;- vk &lt;&lt; n</code></li>
<li><code>vi &lt;- 2^n; vj &lt;- vk / vi</code> par <code>vi &lt;- vk &gt;&gt; n</code></li>
</ul>
</li>
<li>Certains résultats triviaux peuvent donner à des remplacement.<ul>
<li><code>vi &lt;- 0; vj &lt;- vk + vi</code> par <code>vj &lt;- vk</code></li>
<li><code>vi &lt;- 0; vj &lt;- vk - vi</code> par <code>vj &lt;- vk</code></li>
<li><code>vi &lt;- 0; vj &lt;- vi - vk</code> par <code>vj &lt;- -vk</code></li>
<li><code>vi &lt;- 0; vj &lt;- vk * vi</code> par <code>vj &lt;- 0</code></li>
<li><code>vi &lt;- 1; vj &lt;- vk * vi</code> par <code>vj &lt;- vk</code></li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md14"></a>
Instructions ARM</h1>
<p>La liste ci-dessous donnent les instructions ARM utiles pour notre traducteur. Les notations suivantes sont utilisées :</p>
<ul>
<li><em>IMM</em> - valeur immédiate avec un codage constant (8-bit) &gt;&gt;&gt; rotation (4-bit).</li>
<li><em>Ri</em>, <em>Rj</em>, <em>Rk</em> - un registre.</li>
<li><em>LAB</em> - une étiquette.</li>
<li><em>CC</em> - une condition (EQ, LE, GT, GE, LT, LE).</li>
</ul>
<p>Les instructions arithmétiques :</p><ul>
<li><code>add Ri, Rj, Rk</code> - Ri &lt;- Rj + Rk</li>
<li><code>add Ri, Rj, #IMM</code> - Ri &lt;- Rj + IMM</li>
<li><code>and Ri, Rj, Rk</code> - Ri &lt;- Rj &amp; Rk</li>
<li><code>and Ri, Rj, #IMM</code> - Ri &lt;- Rj &amp; IMM</li>
<li><code>div Ri, Rj, Rk</code> - Ri &lt;- Rj / Rk</li>
<li><code>eor Ri, Rj, Rk</code> - Ri &lt;- Rj ^ Rk</li>
<li><code>eor Ri, Rj, #IMM</code> - Ri &lt;- Rj ^ IMM</li>
<li><code>mov Ri, Rj</code> - Ri &lt;- Rj</li>
<li><code>mov Ri, Rj, #IMM</code> - Ri &lt;- IMM</li>
<li><code>mov Ri, Rj, lsl Rk</code> - Ri &lt;- Rj &lt;&lt; Rk</li>
<li><code>mov Ri, Rj, lsl #IMM</code> - Ri &lt;- Rj &lt;&lt; IMM</li>
<li><code>mov Ri, Rj, lsr Rk</code> - Ri &lt;- Rj &gt;&gt; Rk</li>
<li><code>mov Ri, Rj, lsr #IMM</code> - Ri &lt;- Rj &gt;&gt; IMM</li>
<li><code>mul Ri, Rj, Rk</code> - Ri &lt;- Rj * Rk</li>
<li><code>mvn Ri, Rj</code> - Ri &lt;- ~Rj</li>
<li><code>orr Ri, Rj, Rk</code> - Ri &lt;- Rj | Rk</li>
<li><code>orr Ri, Rj, #IMM</code> - Ri &lt;- Rj | IMM</li>
<li><code>rsb Ri, Rj, Rk</code> - Ri &lt;- Rk - Rj</li>
<li><code>rsb Ri, Rj, #IMM</code> - Ri &lt;- IMM + Rj</li>
<li><code>sub Ri, Rj, Rk</code> - Ri &lt;- Rj - Rk</li>
<li><code>sub Ri, Rj, #IMM</code> - Ri &lt;- Rj - IMM</li>
</ul>
<p>Les accès mémoire :</p><ul>
<li><code>ldr Ri, [Rj]</code> - Ri &lt;- Mint[Rj]</li>
<li><code>str Ri, [Rj]</code> - Mint[Rj] &lt;- Ri</li>
</ul>
<p>Les branchements :</p><ul>
<li><code>b LAB</code> - PC &lt;- LAB</li>
<li><code>bCC LAB</code> - si SR[CC] alors PC &lt;- LAB</li>
<li><code>bx Ri</code> - PC &lt;- Ri</li>
<li><code>cmp Ri, Rj</code> - SR &lt;- Ri ~ Rj</li>
<li><code>cmp Ri, #IMM</code> - SR &lt;- Ri ~ IMM </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
